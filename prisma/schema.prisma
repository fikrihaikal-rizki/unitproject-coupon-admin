// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "./generated"
}

datasource db {
  provider = "postgresql"
}

// --- Enums ---

enum StepType {
  claim_seat
  questionnaire
}

enum InputType {
  text
  number
  phone
  email
  select
  multiple_select @map("multiple-select")
  file
}

enum ClaimSeatInputType {
  text
  number
  phone
  email
  select
}

enum EventRegistrationStatus {
  active
  pending
  completed
  cancelled
}

enum ClaimSeatErrorStatus {
  open
  resolved
}

enum AdminRoles {
  admin
  operator
}

model Customer {
  id               String    @id @db.Uuid // References auth.users(id) 
  email            String    @unique
  fullName         String?   @map("full_name")
  phoneNumber      String?   @map("phone_number") @db.VarChar(20)
  blacklistedUntil DateTime? @map("blacklisted_until") @db.Timestamptz
  createdAt        DateTime? @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime? @updatedAt @map("updated_at") @db.Timestamptz

  registrations   EventRegistration[]
  claimSeatErrors ClaimSeatError[]

  @@index([phoneNumber])
  @@map("customers")
}

model EventGroup {
  id                Int       @id @default(autoincrement())
  groupName         String    @map("group_name") @db.VarChar(255)
  slug              String    @unique @db.VarChar(100)
  lockToSingleEvent Boolean?  @default(true) @map("lock_to_single_event")
  createdAt         DateTime? @default(now()) @map("created_at") @db.Timestamptz

  events Event[]

  @@map("event_groups")
}

model Event {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  groupId               Int?      @map("group_id")
  slug                  String    @unique @db.VarChar(100)
  title                 String    @db.VarChar(255)
  description           String?
  bannerPath            String?   @map("banner_path")
  startAt               DateTime? @default(now()) @map("start_at") @db.Timestamptz
  endAt                 DateTime? @default(now()) @map("end_at") @db.Timestamptz
  successGreeting       String?   @default("Registrasi Berhasil!") @map("success_greeting")
  successDescription    String?   @map("success_description") @db.Text
  successPrimaryBtnText String?   @default("Kembali ke Beranda") @map("success_primary_btn_text")
  successPrimaryBtnUrl  String?   @default("/") @map("success_primary_btn_url")
  isActive              Boolean?  @default(true) @map("is_active")
  createdAt             DateTime? @default(now()) @map("created_at") @db.Timestamptz
  updatedAt             DateTime? @updatedAt @map("updated_at") @db.Timestamptz

  group           EventGroup?          @relation(fields: [groupId], references: [id], onDelete: Cascade)
  steps           RegistrationStep[]
  registrations   EventRegistration[]
  claimSeatErrors ClaimSeatError[]
  eventAdmins     EventAdministrator[]
  coupons         EventCoupon[]

  @@map("events")
}

model RegistrationStep {
  id            Int       @id @default(autoincrement())
  eventId       String?   @map("event_id") @db.Uuid
  title         String    @db.VarChar(255)
  description   String?
  stepType      StepType? @map("step_type")
  orderPriority Int?      @default(0) @map("order_priority")
  createdAt     DateTime? @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime? @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt     DateTime? @map("deleted_at") @db.Timestamptz

  event       Event?                  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  questions   QuestionnaireQuestion[]
  seatConfigs ClaimSeatConfig[]

  @@map("registration_steps")
}

model QuestionnaireQuestion {
  id            Int        @id @default(autoincrement())
  stepId        Int?       @map("step_id")
  label         String     @db.VarChar(100)
  description   String     @map("description")
  inputType     InputType? @map("input_type")
  options       Json?
  placeholder   String?    @db.VarChar(255)
  isRequired    Boolean?   @default(true) @map("is_required")
  orderPriority Int?       @default(0) @map("order_priority")
  createdAt     DateTime?  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime?  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt     DateTime?  @map("deleted_at") @db.Timestamptz

  step    RegistrationStep?     @relation(fields: [stepId], references: [id], onDelete: Cascade)
  answers QuestionnaireAnswer[]

  @@map("questionnaire_questions")
}

model ClaimSeatConfig {
  id          Int                 @id @default(autoincrement())
  stepId      Int?                @map("step_id")
  label       String              @db.VarChar(100)
  description String              @map("description")
  inputType   ClaimSeatInputType? @map("input_type")
  options     Json?
  placeholder String?             @db.VarChar(255)
  createdAt   DateTime?           @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime?           @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt   DateTime?           @map("deleted_at") @db.Timestamptz

  step RegistrationStep? @relation(fields: [stepId], references: [id], onDelete: Cascade)

  @@map("claim_seat_configs")
}

model EventRegistration {
  id             Int                      @id @default(autoincrement())
  eventId        String?                  @map("event_id") @db.Uuid
  customerId     String?                  @map("customer_id") @db.Uuid
  claimSeatValue String?                  @map("claim_seat_value") @db.VarChar(255)
  qrCodeData     String                   @unique @map("qr_code_data")
  status         EventRegistrationStatus? @default(active)
  registeredAt   DateTime?                @default(now()) @map("registered_at") @db.Timestamptz
  updatedAt      DateTime?                @updatedAt @map("updated_at") @db.Timestamptz

  event    Event?                @relation(fields: [eventId], references: [id], onDelete: Cascade)
  customer Customer?             @relation(fields: [customerId], references: [id], onDelete: Cascade)
  answers  QuestionnaireAnswer[]
  coupon   CustomerCoupon[]

  @@unique([customerId, eventId])
  @@unique([eventId, claimSeatValue])
  @@index([eventId, status])
  @@index([claimSeatValue])
  @@map("event_registrations")
}

model QuestionnaireAnswer {
  id             Int       @id @default(autoincrement())
  registrationId Int?      @map("registration_id")
  questionId     Int?      @map("question_id")
  answerValue    String    @map("answer_value")
  createdAt      DateTime? @default(now()) @map("created_at") @db.Timestamptz

  question     QuestionnaireQuestion? @relation(fields: [questionId], references: [id], onDelete: Cascade)
  registration EventRegistration?     @relation(fields: [registrationId], references: [id], onDelete: Cascade)

  @@map("questionnaire_answers")
}

model ClaimSeatError {
  id           Int                   @id @default(autoincrement())
  eventId      String?               @map("event_id") @db.Uuid
  customerId   String?               @map("customer_id") @db.Uuid
  triedValue   String?               @map("tried_value")
  errorMessage String                @map("error_message")
  status       ClaimSeatErrorStatus? @default(open) @map("status")
  createdAt    DateTime              @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime?             @updatedAt @map("updated_at") @db.Timestamptz

  event    Event?    @relation(fields: [eventId], references: [id])
  customer Customer? @relation(fields: [customerId], references: [id])

  @@index([eventId, createdAt(sort: Desc)])
  @@map("claim_seat_errors")
}

model Administrator {
  id        Int         @id @default(autoincrement())
  email     String      @unique
  fullname  String
  password  String
  isActive  Boolean     @default(true) @map("is_active")
  role      AdminRoles? @map("role") @default(admin)
  createdAt DateTime?   @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime?   @updatedAt @map("updated_at") @db.Timestamptz

  eventAdmins    EventAdministrator[]
  scannedCoupons CustomerCoupon[]

  @@map("administrators")
}

model EventAdministrator {
  id      Int    @id @default(autoincrement())
  userId  Int    @map("user_id")
  eventId String @map("event_id") @db.Uuid

  admin Administrator @relation(fields: [userId], references: [id], onDelete: Cascade)
  event Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("event_administrators")
}

model EventCoupon {
  id                 Int       @id @default(autoincrement())
  eventId            String    @map("event_id") @db.Uuid
  name               String
  code               String
  slug               String    @unique @default(cuid())
  description        String?   @db.Text
  allowGenerateFrom  DateTime  @map("allow_generate_from") @db.Timestamptz
  allowGenerateUntil DateTime  @map("allow_generate_until") @db.Timestamptz
  redeemFrom         DateTime  @map("redeem_from") @db.Timestamptz
  redeemUntil        DateTime  @map("redeem_until") @db.Timestamptz
  maxQuota           Int?      @map("max_quota")
  isActive           Boolean   @default(true) @map("is_active")
  totalGenerated     Int       @default(0) @map("total_generated")
  totalRedeemed      Int       @default(0) @map("total_redeemed")
  createdAt          DateTime? @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime? @updatedAt @map("updated_at") @db.Timestamptz

  event           Event            @relation(fields: [eventId], references: [id])
  customerCoupons CustomerCoupon[]

  @@index([slug])
  @@map("event_coupons")
}

model CustomerCoupon {
  id             Int       @id @default(autoincrement())
  registrationId Int       @map("registration_id")
  eventCouponId  Int       @map("event_coupon_id")
  qrData         String    @unique @map("qr_data")
  isRedeemed     Boolean   @default(false) @map("is_redeemed")
  generatedAt    DateTime  @default(now()) @map("generated_at") @db.Timestamptz
  redeemedAt     DateTime? @map("redeemed_at") @db.Timestamptz
  scannedById    Int?      @map("scanned_by_id")

  registration EventRegistration @relation(fields: [registrationId], references: [id])
  eventCoupon  EventCoupon       @relation(fields: [eventCouponId], references: [id])
  scannedBy    Administrator?    @relation(fields: [scannedById], references: [id])

  @@index([eventCouponId, isRedeemed])
  @@index([qrData])
  @@map("customer_coupons")
}
